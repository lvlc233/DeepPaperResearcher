---
name: 后端架构设计稿
description: |
    该文档是后端项目的架构文档,
    该文档以模块化设计为驱动，设计了从业务任务到功能模块的映射关系，并描述了每个模块内部的功能和输入输出。
    [仅后端Agent,仅读]
author: "lxz"
state: OK
created: 2026-01-01
path: "/PROJECT"
---

# 后端架构设计稿
# 论文模块
## 功能列表
### 论文的上传与获取
论文的上传包括网络加载和本地加载这两种方式，不够最后都是转化为本地资源或者对象存储。所以就有2种输入和2种输出。

#### 输入（Input）
1. 需要支持从网络上传,这就需要
    1. 网络资源的解析,得到pdf的url
    2. 将pdf下载为本地的能力(or)
    3. 将pdf直接从url转化为对象的能力(or)
    4. **去重机制**: 需检查URL或文件Hash，避免重复下载/存储。
2. 需要支撑本地上传
    1. 需要对本地路径进行加载,得到本地的pdf文件
3. 需要支持从本地资源加载
    1. 本地资源包括本地文件,数据库存储,向量存储+其他的存储
    2. 需要具备pdf数据的解析
    3. 需要具备从pdf数据中提取文本的能力。
4. 需要支持从对象存储加载
    1. 需要具备从对象存储中加载pdf数据的能力
    2. 需要具备从pdf数据中提取文本的能力。

#### 输出（Output）
1. **论文内容获取**: 前端需要通过API获取已下载/转化的PDF文件流进行预览（解决跨域问题）。
2. **论文元数据**: 获取论文的标题、作者、摘要、处理状态等。
3. **删除机制**: 支持级联删除（文件、数据库记录、向量数据）。

#### 状态管理
由于解析和向量化是耗时操作，需引入状态机：
- `PENDING`: 已创建记录，等待处理
- `PROCESSING`: 下载/解析/向量化进行中
- `COMPLETED`: 处理完成，可供搜索和问答
- `FAILED`: 处理失败，记录错误信息

#### 支撑层
- 对象存储支持模块(暂时不做)
- 数据库模块
    1. 元数据:
    - pdf元数据对象->pdf持久化(id,url, status)
    - pdf_id->pdf元数据对象(url)
    2. 向量:
    - 向量对象+元数据->向量持久化(id,向量,元数据)
    - pdf_id->pdf向量对象(id,向量,元数据)
    - 向量->pdf向量对象(id,向量,元数据)
- 文件系统模块
    2. local->pdf对象
- 网络模块
    1. http->网络对象(pdf_url)
    2. pdf_url->local
中间支持:
- pdf解析模块
    1. pdf对象->pdf文本对象
    2. pdf对象->元数据(Title, Authors, Abstract)
- 向量化模块
    2. pdf文本对象->向量对象
    3. 文本->切块
...
<!-- 
# 支撑层逆转(仅读,支持层做的事情以功能列表为主) -->


业务模型层:
业务模型层不应是一个独立的、存放静态数据的仓库，而是分散在各个业务模块边界上的、用于定义模块行为的契约集合。

#### 核心哲学：SaaS 化模块设计
1. **数据模型即业务边界**：
   - 模型不再是某种固定的类型（如全局的 `User` 对象），而是模块与模块之间交互的协议（Protocol）。
   - 对于 Web 层：模型就是 `Request` / `Response`。
   - 对于 内部业务模块（如 PDF解析器）：模型就是 `RawData` (Input) / `ParsedContent` (Output)。

2. **输入/输出契约（Input/Output Contracts）**：
   - 每个功能模块（Function/Module）都必须显式定义其 `Input` 和 `Output` 模型。
   - 禁止模块间隐式依赖或透传内部实体（Entity）。
   - 复杂模块内部可以包含多个子模块的调用链（`f(Input) -> g -> h -> Output`），但对外部调用者而言，只暴露最终的 Input/Output。

3. **优势**：
   - **高复用性**：模块只依赖明确的输入，易于替换和测试。
   - **低耦合**：消灭了“一个大对象传遍全系统”的现象。
   - **边界清晰**：强制思考模块的职责边界。

servcie service and work层:
这里应该是业务服务的直接映射和最相关理解。
以提供了论文上传和解析相关的服务。

# 用户与认证模块
## 功能列表
提供基础的用户注册、登录及个人设置管理。

### 输入 (Input)
1. **认证信息**: Email, Password (Hash), Full Name.
2. **设置信息**: Theme, Language, etc.

### 输出 (Output)
1. **Token**: JWT Access Token.
2. **User Profile**: 用户基本信息及设置。

### 支撑层
- 数据库模块: Users 表。
- 安全模块: Password Hashing (bcrypt), JWT Generation/Validation.

# 阅读器交互模块
## 功能列表
支持 PDF 阅读过程中的图层管理、标注同步。采用 "View as Layer" 架构。

### 输入 (Input)
1. **图层操作**: 创建/删除图层，设置可见性。
2. **标注数据**: 矩形坐标 (Rects), 内容 (Content), 颜色 (Color), 类型 (Highlight/Note).

### 输出 (Output)
1. **图层列表**: 包含该论文下的所有图层及标注。
2. **标注更新**: 实时保存的标注对象。

### 支撑层
- 数据库模块: Layers, Annotations 表。
- 业务逻辑: 权限校验 (只能操作自己的图层/标注)。

# 报告生成模块
## 功能列表
支持生成深度研究报告 (Deep Research) 和相关工作综述 (Related Work)。

### 输入 (Input)
1. **任务指令**: 报告类型, 目标论文 ID。
2. **生成状态**: 异步任务的状态更新。

### 输出 (Output)
1. **报告内容**: Markdown 格式的报告全文。
2. **结构化摘要**: 关键点提取。

### 支撑层
- Agent 编排: 调用 DeepResearchAgent 执行多步生成。
- 任务队列: Arq 异步任务处理耗时生成。

(感觉可以合并到统一架构文案中。)