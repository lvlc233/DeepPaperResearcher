# 2026-01-20 后端变更日志

## 16:01 Refactor User Settings Storage
- **目标**: 优化 `User` 实体中 `settings` 字段的存储方式，实现 Pydantic 模型与 PostgreSQL JSON 列的自动映射。
- **变更范围**:
  - 新增 `src/common/db_types.py`: 添加 `PydanticJSON` TypeDecorator。
  - 修改 `src/base/pg/entity.py`: `User.settings` 字段类型改为 `Settings`，并使用 `PydanticJSON(Settings)`。
  - 修改 `src/service/setting/setting_service.py`: 移除冗余的 `_normalize_settings` 方法，简化 CRUD 逻辑。
- **验证方式**: 运行 `pytest test/src/test_user_settings.py`。
- **结果**: 测试通过，CRUD 功能正常，数据库自动处理 JSON 序列化与反序列化。

## 16:30 Refactor SettingService to Repository Pattern
- **目标**: 将 `SettingService` 中的直接数据库操作重构为调用 `UserRepository`，遵循分层架构原则。
- **变更范围**:
  - 修改 `src/service/setting/setting_service.py`: `_get_user` 和 `_save_settings` 方法改为调用 `UserRepository`。
- **验证方式**: 代码审查确认 `SettingService` 中无直接 DB 操作；原有测试用例通过。
- **结果**: Service 层不再直接依赖 `select`/`commit`，职责分离更清晰。

## 23:08 Implement Paper Migration and Fix Data Model Penetration
- **目标**: 实现论文在收藏夹之间的迁移功能，并解决收藏夹数据模型穿透问题（移除不必要的描述字段）。
- **变更范围**:
  - 修改 `src/controller/api/collections/router.py`: 新增 `PATCH /{collection_id}/papers/move/{paper_id}` 接口，替换错误的 `add_paper_to_collection` 接口。
  - 修改 `src/controller/api/collections/schema.py`: `CollectionResponse` 移除 `description` 字段，修正字段别名。
  - 修改 `src/service/collections/collection_service.py`: 实现 `move_paper` 逻辑，更新 `CollectionDTO`。
  - 更新测试: `test_collections_router.py` 和 `test_papers_router.py`。
- **验证方式**: 运行 `pytest main/backend/test/src/test_collections_router.py`。
- **结果**: 测试全部通过，功能符合预期。

## 23:38 Fix Reader Module Import Errors and Secure Endpoints
- **目标**: 解决阅读模块测试中的 `NoteMetaResponse` 导入错误，修复 endpoint 冲突，消除 Pydantic 弃用警告，并为所有阅读模块接口添加用户身份验证。
- **变更范围**:
  - 修改 `src/service/reader/reader_service.py`: 修复 schema 导入，增强 `get_paper_meta` 等方法以支持用户 ID 过滤 (RLS)。
  - 修改 `src/controller/api/reader/router.py`: 重命名 `get_paper_meta` 路由避免冲突，确保所有接口注入 `current_user` 依赖。
  - 修改 `src/controller/api/reader/schema.py`, `src/controller/api/collections/schema.py`, `src/service/collections/schema.py`, `src/base/pdf_parser/parser.py`: 将 Pydantic `class Config` 迁移为 `ConfigDict`。
  - 修改 `test/src/test_reader_v2.py`: 修复 sys.path 路径，更新测试路由，Mock `current_user` 依赖。
- **验证方式**: 运行 `pytest test/src/test_reader_v2.py`。
- **结果**: 8 个测试项全部通过，Pydantic 警告消除（仅剩第三方库警告）。

# 2026-01-21 后端变更日志

## 10:08 Refactor Reader Module: Split Services and DTO Migration
- **目标**: 将 `ReaderService` 拆分为多个细粒度的领域服务（TOC, View, Note, Summary, MindMap, History, Job），并将 DTO 定义从 Controller 层迁移到 Service 层，以提高代码的可维护性和职责分离。
- **变更范围**:
  - 新增服务: `toc_service.py`, `view_service.py`, `history_service.py`, `job_service.py`。
  - 更新服务: `note_service.py`, `summary_service.py`, `mind_map_service.py`，增加查询逻辑。
  - 重构 `reader_service.py`: 移除被拆分的方法，保留 `get_paper_meta` 作为聚合入口。
  - 重构 `reader/router.py`: 注入具体服务替代 `ReaderService` 的直接调用。
  - 迁移 DTO: 将 `Toc`, `View`, `NoteMeta` 等模型从 `controller/api/reader/schema.py` 移动到 `service/reader/schema.py`。
  - 更新测试: `test_reader_v2.py` 适配新的服务依赖注入。
- **验证方式**: 运行 `pytest test/src/test_reader_v2.py`。
- **结果**: 测试通过，服务拆分完成，路由层依赖更清晰。

## 13:21 Refine Reader DTO Boundaries and Repository Removal
- **目标**: 移除 Reader 子服务对仓储的依赖，并统一服务层返回 DTO，避免 Controller 直接依赖实体或混用模型。
- **变更范围**:
  - 修改 `src/service/reader/schema.py`: 为 `NoteDTO` 增加 `page` 字段，新增 `PaperReaderMeta` DTO。
  - 修改 `src/service/reader/reader_service.py`: 返回 `PaperReaderMeta`，移除 Controller Schema 依赖。
  - 修改 `src/service/reader/note_service.py`, `view_service.py`, `history_service.py`, `mind_map_service.py`, `summary_service.py`: 改为直接查询并输出 DTO。
  - 修改 `src/controller/api/reader/router.py`: 将服务层 DTO 映射为响应模型。
  - 修改 `test/src/test_reader_v2.py`: Mock 改为 service DTO。
- **验证方式**: 运行 `python -m pytest`。
- **结果**: 测试通过，Reader 模块 DTO 边界更清晰。

## 13:38 Restore Reader Repository Usage
- **目标**: 恢复 Reader 子服务通过仓储访问数据库，修复类型定义顺序导致的导入错误。
- **变更范围**:
  - 修改 `src/service/reader/note_service.py`, `view_service.py`, `history_service.py`, `mind_map_service.py`, `summary_service.py`: 改为调用 `ReaderRepository`/`PaperRepository`。
  - 修改 `src/service/reader/schema.py`: 调整 `AISummary`、`PaperReaderMeta` 等定义顺序，避免 `NameError`。
- **验证方式**: 运行 `pytest`。
- **结果**: 失败，测试收集阶段报错：`ChatSession` 与 `AISearchSettingsRequest` 导入不存在（与本次改动无直接关联）。
