# FrontendAgent Memory

## 角色定位
FrontendAgent 负责 DeepPaperResearcher 项目的前端开发，目标是构建一个轻量级、模块化、高性能的论文辅助研究平台。

## 项目深度理解 (2026-01-06 更新)

### 核心目标
本项目是一个 **"+AI" 的轻量级论文辅助研究平台**。前端的核心任务是**降低心智负担**：既要提供传统论文管理工具（如 Zotero）的严谨性，又要融合 AI Agent（Deep Research）的智能化体验，通过流畅的 UI/UX 让 AI 的介入显得自然且高效。

### 业务模块详解
根据 UI 设计稿，前端工程被划分为三个高内聚的业务域：

#### 1. 首页 (入口与引导)
*   **功能**: 极简入口，聚焦于“开始研究”这一动作（搜索、上传）。
*   **关键点**: 引导用户进入管理或阅读流程，需通过权限拦截确保数据安全。

#### 2. 管理页 (资源组织)
*   **功能**: 用户的“个人图书馆”。包含收藏夹管理、论文列表、元数据筛选。
*   **特色**:
    *   **混合搜索**: 传统关键词搜索 + **AI 辅助搜索**（需处理 AI 推荐原因与分数的实时流式渲染）。
    *   **视图切换**: 支持用户自定义展示字段，适应不同研究阶段的信息密度需求。
    *   **技术难点**: 长列表性能优化（虚拟滚动）、大文件上传切片。

#### 3. 阅读页 (核心交互区)
这是前端最复杂、技术含量最高的模块：
*   **PDF 阅读器 + 视图层 (View Layer)**:
    *   **核心概念**: **“视图即玻璃板”**。用户对论文的高亮、笔记不直接修改 PDF 文件，而是存储为独立的 Layer（视图）。
    *   **交互**: 支持视图的叠加、隐藏、切换。这要求前端实现一层高效的 Canvas/SVG 覆盖层，与底层的 PDF 坐标系统精确同步。
    *   **技术挑战**: DOM 节点性能（Canvas/虚拟化）、坐标系统同步。
*   **AI 辅助组件 (侧边栏)**:
    *   **多模态交互**: 导读（对话）、脑图（只读可视化）、笔记（Markdown 编辑器）、报告（深度研究结果展示）。
    *   **深度研究**: 这是一个**非阻塞**的长流程。前端需要处理“挂起任务 -> 后台运行 -> 轮询/推送状态 -> 生成报告”的完整生命周期，期间用户可继续阅读或对话。
    *   **通信协议**: SSE (Server-Sent Events) 用于流式输出。

### 技术架构蓝图 (预期)
遵循 `SPECIFICATION.md` 和 `Next.js + React` 生态：

*   **框架**: **Next.js** (App Router 优先)。利用 SSR 提升 SEO，RSC 减少 Bundle 体积。
*   **状态管理**:
    *   **Server State**: `React-Query` (API 数据、AI 历史)。
    *   **Client State**: `State -> Hook -> Context -> Store` (Zustand/Context 用于 PDF 视图层控制)。
*   **通信**: RESTful (常规) + SSE (AI 流式)。
*   **规范**: TypeScript Strict Mode, 模块化 (Pages/Components/Hooks/Services)。

## 开发规范
-   **组件**: 纯函数，副作用收敛。
-   **类型**: 严禁 Any，优先 `.d.ts`。
-   **性能**: 组合优于透传，合理使用 Memoization。
-   **兼容性**: Chrome/Edge/Safari/Firefox 最新版。
-   **安全**: Token 不硬编码，走环境变量。

## 当前状态
-   [x] T-005 初始化完成。
-   [x] T-006 技术调研待开始。

## 项目深度理解 (2026-01-11 更新)

### 搜索与导航的交互模式
在实现 Dashboard 时，确立了“侧边栏驱动上下文，搜索栏驱动内容”的交互模式：
- **侧边栏 (Sidebar)**: 定义搜索范围（全局 vs 特定收藏夹）。选中收藏夹时，搜索仅限于该范围；点击“搜索论文”按钮时，重置为全局模式。
- **搜索栏 (SearchBar)**: 触发具体的查询动作。需感知当前的上下文（`activeCollection`）并传递给后端（或模拟逻辑）。
- **AI 增强**: 搜索结果不仅仅是列表，通过 `isAIEnabled` 标志位动态注入“AI 评分”和“推荐理由”，在 UI 上与普通元数据做明显区分。

### 布局稳定性经验
对于“侧边栏 + 内容区”的经典布局，在 Next.js / Tailwind 环境下，必须显式限制根容器高度：
- **根容器**: `h-screen overflow-hidden` 锁定视口。
- **侧边栏**: `h-full` 占满高度。
- **内容区**: `flex-1 overflow-y-auto` 独立滚动。
这避免了页面整体滚动导致侧边栏消失的问题，提升了沉浸式体验。

## 项目深度理解 (2026-01-11 晚间更新 - 视图系统)

### 视图与操作系统的核心设计
在实现 PDF 阅读器的标注功能时，明确了“**视图即图层 (View as Layer)**”的技术实现路径：

1.  **图层架构 (Layer Architecture)**
    *   **定义**: 一个“视图”在代码层面对应一个 `Layer` 对象，包含一组 `Annotation` 数据。
    *   **叠加机制 (Overlay)**: 系统支持同时显示多个 `visible: true` 的图层。UI 上表现为不同来源（如“系统解析”、“用户笔记”、“团队共享”）的标注叠加显示在同一页 PDF 上。
    *   **活动图层 (Active Layer)**: 任何时刻只能有一个 `Active Layer`。所有新产生的交互操作（高亮、笔记）都会自动归属到当前的活动图层中。

2.  **坐标系统设计 (Coordinate System)**
    *   为了适配 PDF 在不同屏幕尺寸和缩放比例下的显示，放弃了绝对像素坐标。
    *   **百分比坐标**: 所有标注 (`Rect`) 使用 `0-100%` 的相对坐标存储。
    *   **渲染逻辑**: `left: ${x}%`, `top: ${y}%`。这确保了无论 PDF 如何缩放，标注位置始终相对于页面内容固定。

3.  **组件通信流**
    *   **ReaderPage (Hub)**: 持有 `layers` 和 `activeLayerId` 的完整状态。
    *   **ReaderSidebar**: 仅作为控制面板，通过 Props 接收状态并触发 `onToggleVisibility` / `onSetActive` 等回调。
    *   **PDFViewer -> PDFPageOverlay**: 仅作为渲染和事件捕获层。监听到文本选择后，计算百分比坐标，向上层冒泡 `onAddAnnotation` 事件，不自行维护状态。

## 项目深度理解 (2026-01-11 晚间更新 - 标注交互与辅助体验)

### 交互难点攻克：Pass-Through Interaction
在开发 PDF 标注功能时，遇到了一个典型痛点：**标注层遮挡了文本层**，导致用户无法在已高亮的文本上再次进行选择操作（例如想要修改颜色或叠加笔记）。
解决方案采用了 **CSS + JS 协同处理**：
- **CSS**: 对所有标注渲染元素应用 `pointer-events-none`，使其在浏览器事件模型中“隐形”，鼠标事件直接穿透到底层的 PDF 文本层。
- **JS**: 为了保留对标注的点击（编辑）和悬停（预览）能力，我们在父级容器实现了**手动事件代理**。监听容器的 `onClick` 和 `onMouseMove`，实时计算鼠标坐标是否落在某个标注的 `Rect` 范围内。
这种模式完美实现了“**视觉上的覆盖，交互上的穿透**”，让用户体验到了如同真实纸笔般的自由叠加感。

### 辅助工具哲学：Transient Mode (临时态)
对于“翻译”这类辅助功能，我们重新定义了其交互生命周期：
- **拒绝污染**: 用户的大部分翻译需求是“阅后即焚”的，不应默认生成一条持久化的 Annotation 下划线，这会造成页面视觉污染。
- **临时弹窗**: 翻译结果首先以**悬浮卡片**形式展示，独立于图层系统之外。
- **按需沉淀**: 仅当用户明确点击“保存为备注”时，系统才将其转化为持久化的笔记数据。
这种**“临时态 -> 持久态”的转化机制**，既满足了轻量级辅助需求，又保留了知识沉淀的通道。
